## 大名鼎鼎的一致性算法——Raft协议

## 一、引入

### 1、分布式领域的问题

> 分布式领域中不得不考虑的三大问题：
>
> - 1、如何多快好省的对大规模数据集进行存储和计算？ 
>   - a.更好的机器
>   - b.更多的机器
>
> - 2、如何让跨网络的机器之间协调一致的工作？
>   - a.状态的立即一致
>   - b.状态的最终一致
>
> - 3、如何应对网络的不可靠以及节点的失效？ 
>   - a.可读写
>   - b.可读 
>   - c.不可用

以上问题的根本原因在于**网络的不确定性**。

> 单节点的优势在于，单机的内存和磁盘读写操作都是很稳定的，要么成功，要么失败，则耗时很短。
>
> 而分布式引入了网络交互的流程，网络请求的耗时远远慢于单机操作，且网络请求可能存在丢失、超时、乱序等异常情况，这些情形都需要被妥善处理，从而导致系统整体复杂度的上升。

### 1、一致性算法

组织机器使其状态最终一致并允许局部失败的算法称之为**一致性算法**。

> 也称**分布式一致性共识算法**，指的是在分布式系统中，使得所有节点对同一份数据的认知能够达成共识的算法。

一致性算法是一类特殊的算法，主要用于分布式系统中实现一致性的处理。在分布式系统中，由于存在多个节点，因此需要有一种机制来保证所有节点都能达成一致的状态。一致性算法就是解决这个问题的算法。

一致性算法有很多种，其中比较著名的包括Paxos、Raft等。这些算法都试图在分布式系统中实现强一致性，即不论系统发生什么故障，都能保证所有节点看到相同的系统状态。

- Paxos算法是一种经典的分布式一致性算法，它分为两个阶段：Prepare阶段和Accept阶段。在Prepare阶段，节点之间互相交换提议，试图达成一致的状态；在Accept阶段，节点之间互相发送确认消息，最终选出被大多数节点接受的提案。

- Raft算法是一种新的分布式一致性算法，它引入了选举机制和心跳机制，使得系统能够更加快速地选出新的领导者，并且保持系统的可用性和稳定性。

**总之，一致性算法是分布式系统中的重要组成部分，它们能够保证所有节点都能达成一致的状态，从而保证系统的可用性和可靠性**。

### 2、CAP理论

- C（ Consitency，一致性 ）： 强调数据的正确一致性。
- A（ Availability，可用性）： 强调使用服务的体验。
- P（ P：Partition tolerance，分区容错性 ）： 强调在网络环境不可靠的情况下仍然可以正常运作。

CAP 理论强调的是，一个系统中，C、A、P 三项性质至多只能满足其二，即每个系统依据其架构设计会具有 CP、AP 或者 CA 的倾向性。

对于分布式系统而言，P 是必须得到保证的。所以实际上只需要考虑CP和AP两种情况。

>  分布式系统中，C 和 A 之间的矛盾正是在于**网络环境的不稳定**。

- CP：强调系统数据的正确性，但由于建立保证不同节点间保证数据严格一致的机制，可能会牺牲系统的可用性。
-  AP：强调系统的可用性，那就必须在数据一致性上做出妥协退让。

> 分布式一致性共识算法，实际上是在基于各种精妙的算法机制，能够在尽可能少地牺牲 C 的基础之上，将 A 提升到尽可能高的水平。
>
> eg： 在可用性 A 方面，raft 算法能保证当分布式系统中存在半数以上节点存活时，系统是稳定可用的，同时请求耗时取决于多数派的下限，而非所有节点的下限； 
>
> eg：在一致性 C 方面，标准的 raft 算法能够保证数据满足最终一致性，同时在各种工程化的落地实现中，可以在 raft 算法的基础上稍加改进，即可保证数据的即时一致性，进一步做到强 C。

## 二、Raft算法

> Paxos算法由来已久，目前是功能和性能最完善的一致性算法，然而它难以理解与实现。
>
> Raft简化了 Paxos，它是以易于理解为首要目标，尽量提供与Paxos一样的功能与性能。

### 1、基本概念

- 领导者（leader）：
-  跟随者（follower）：
- 候选人（candidate）：
- 最终一致性（finnal consistency）：
- 即时一次性（immediate consistency）：
- 预写日志（write ahead log）：
- 状态机（state machine）：
- 提议（proposal）：
- 提交（commit）：
- 应用（apply）：
- 任期（term）：
- 日志索引（index）：
- 脑裂（brain split）：

### 2、核心概念

- 多数派原则
- 一主多从、读写分离
- 状态机与预写日志
- 两阶段提交
- 领导者选择
- 任期与日志索引





## 三、Raft角色流转

### 1、领导者

### 2、跟随者

### 3、候选人



## 四、Raft流程

### 1、写请求流程

### 2、读请求流程

### 3、日志同步流程

### 4、竞选拉票流程















## 五、Raft 对比 Paxos

### 1、简述Paxos算法

Paxos算法是一种经典的分布式一致性算法，它主要解决的是在分布式系统中如何就某个决议达成一致的问题。Paxos算法分为三个阶段：Proposer阶段、Acceptor阶段和Learner阶段。

- Proposer阶段

  在Proposer阶段，一个或多个提议者（Proposer）可以发起提案（Proposal），提议者会将自己的提案ID和提议的值（Value）一起发送给所有的Acceptor。

- Acceptor阶段

  在Acceptor阶段，Acceptor收到提议后，会根据一定的规则进行判断，如果接受的提案ID等于自己已经接受的提案ID，或者接受的提案ID大于自己已经接受的提案ID，那么就接受这个提案，并把这个提案发送给所有的Learner。

- Learner阶段

  在Learner阶段，Learner可以学习已经接受的提案，但是只能学习一个提案，即只针对一个确定的提案达成一致。

Paxos算法的核心思想是利用大多数（Majority）机制保证系统的容错能力，即只要有超过一半的节点正常运行，系统就能够正常工作。具体来说，Paxos算法要求系统中超过一半的节点对某个提案达成一致，这样就能够保证系统中所有节点都能够对该提案达成一致。

此外，Paxos算法还要求系统中所有节点之间的通信必须是可靠的、有序的、不会丢失的。这样就能够保证系统中所有节点都能够按照相同的顺序接收和处理消息，从而保证系统的一致性。

总之，Paxos算法是一种经典的分布式一致性算法，它能够保证在分布式系统中所有节点都能就某个决议达成一致，从而保证系统的可用性和可靠性。



### 2、Paxos和Raft的共同点

Paxos算法和Raft算法都是为了在分布式系统中实现一致性而设计的算法，它们有以下共同点：

1. 保证数据的一致性：Paxos算法和Raft算法都是为了在分布式系统中保证数据的一致性，即所有节点都持有相同的系统和数据状态。
2. 基于消息传递：Paxos算法和Raft算法都是基于消息传递的方式来达成一致性，即通过节点之间的消息通信来协商和同步系统状态。
3. 选举机制：Paxos算法和Raft算法都采用了选举机制来确定一个或多个领导者（leader），由领导者来处理所有的客户端请求并协调其他节点的操作。
4. 安全性考虑：Paxos算法和Raft算法在设计时都考虑了安全性问题，即确保只有合法的节点才能被选举为领导者，并处理客户端请求。
5. 可扩展性：Paxos算法和Raft算法都是可扩展的，可以适用于不同规模的分布式系统。

总之，Paxos算法和Raft算法都是为了在分布式系统中实现一致性而设计的算法，它们在保证数据一致性、基于消息传递、选举机制、安全性考虑和可扩展性等方面有共同点。



### 3、Paxos 和 Raft 的不同点

简单介绍一下两种算法的不同之处。Paxos算法的核心思想是通过多数派选举产生一个领导者（Leader），由领导者来协调所有节点的操作。在Paxos算法中，每个节点都有一个编号，节点之间通过编号来传递提案和决议。Paxos算法分为多个阶段，每个阶段都有不同的任务和要求。

相比之下，Raft算法的核心思想是通过选举产生一个领导者（Leader）和一个或多个跟随者（Follower），由领导者来协调所有节点的操作。在Raft算法中，节点之间通过心跳消息来维持联系，领导者会定期向其他节点发送心跳消息，跟随者收到心跳消息后会尝试成为领导者或者继续保持跟随者的角色。Raft算法也分为多个阶段，但相比Paxos算法要简单一些。

Paxos算法和Raft算法在解决分布式系统一致性问题上有很多相似之处，但也有一些不同之处。以下是它们的不同之处：

1. 日志复制方式：Paxos算法采用的是多数派决策的方式，即当多数派节点接收到相同的决策时，就将这个决策写入到自己的日志中。而Raft算法采用的是领导人方式，即由领导人负责将日志复制到所有的节点中。
2. 领导人选举机制：Paxos算法中的领导人是由所有节点共同决定的，而Raft算法中的领导人则是通过选举产生的。
3. 数据同步方式：Paxos算法中的数据同步是异步的，即当一个节点提交了一个请求后，不需要等待其他节点的回应。而Raft算法则是同步的，即当一个节点提交了一个请求后，需要等待大多数节点的回应后才能继续执行下一个操作。
4. 可扩展性：Paxos算法在实际应用中难以扩展，而Raft算法相对来说更容易扩展。
5. 优化目标：multi-paxos leader是作为对经典paxos的优化而提出，通过选择一个proposer（提案人）作为leader降低多个proposer引起冲突的频率，提升性能将一次决议的平均消息代价缩小到最优的两次。而经典的paxos算法分为两个阶段，第一个阶段去询问值，第二阶段根据询问的结果提出值。

总之，Paxos算法和Raft算法在解决分布式系统一致性问题上各有特点，需要根据实际情况进行选择。



### 4、Paxos和Raft适用场景

Paxos算法和Raft算法都是为了在分布式系统中实现一致性而设计的算法。它们适用于不同的场景，但都能够在分布式系统中保证数据的一致性。

Paxos算法适用于对性能要求不高、对数据一致性要求严格的场景。例如，在一些金融系统中，数据的一致性是非常重要的，因此会选择使用Paxos算法来实现一致性。另外，Paxos算法的实现比较复杂，需要投入大量的人力物力进行开发和维护，因此也适用于一些对性能要求不高、对开发成本不敏感的场景。

Raft算法则适用于对性能要求较高、对数据一致性要求也比较高的场景。例如，在一些大规模的分布式系统中，数据的读写非常频繁，因此需要一个高效的分布式一致性算法来保证系统的可用性和可靠性。另外，Raft算法的实现相对简单，易于理解和实现，因此也适用于一些对开发成本要求较高的场景。

总之，Paxos算法和Raft算法都是为了在分布式系统中实现一致性而设计的算法，它们适用于不同的场景，但都能够在分布式系统中保证数据的一致性。具体选择哪种算法要根据实际情况进行权衡和选择。



参考文档：https://hardcore.feishu.cn/docs/doccnMRVFcMWn1zsEYBrbsDf8De
参考文档：https://mp.weixin.qq.com/s/nvg9J4ky9mz-dFVi5CyYWg
参考文档：https://zhuanlan.zhihu.com/p/31780743/

参考文档：https://zhuanlan.zhihu.com/p/31780743/

